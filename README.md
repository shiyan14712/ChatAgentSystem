# Chat Agent Framework

<div align="center">

![Python](https://img.shields.io/badge/Python-3.12+-blue.svg)
![FastAPI](https://img.shields.io/badge/FastAPI-0.115+-green.svg)
![Vue](https://img.shields.io/badge/Vue-3.5+-brightgreen.svg)
![TypeScript](https://img.shields.io/badge/TypeScript-5.6+-blue.svg)
![License](https://img.shields.io/badge/License-MIT-yellow.svg)

**ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„èŠå¤©å¯¹è¯Agentæ¡†æ¶ï¼Œæ”¯æŒOpenAI Compatible API**

[åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§) â€¢ [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹) â€¢ [APIæ–‡æ¡£](#apiæ–‡æ¡£) â€¢ [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜) â€¢ [æ‰©å±•å¼€å‘](#æ‰©å±•å¼€å‘)

</div>

---

## 1 ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#2)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æ‰©å±•å¼€å‘](#æ‰©å±•å¼€å‘)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)

---

## 2 åŠŸèƒ½ç‰¹æ€§

> ğŸ·ï¸ Label è¯´æ˜ï¼ˆä»…æ ‡æ³¨åç«¯ï¼‰ï¼š
> - `ã€æœªå®ç°ã€‘`ï¼šæ–‡æ¡£ä¸­æœ‰èƒ½åŠ›æè¿°ï¼Œä½†å½“å‰åç«¯ä»£ç æœªè½åœ°
> - `ã€éƒ¨åˆ†å®ç°ã€‘`ï¼šå·²æœ‰åŸºç¡€èƒ½åŠ›ï¼Œä½†æœªå½¢æˆå®Œæ•´é—­ç¯
> - `ã€æœªæ¥å…¥ä¸»é“¾è·¯ã€‘`ï¼šæ¨¡å—å·²å®ç°ï¼Œä½†å½“å‰ API ä¸»è°ƒç”¨è·¯å¾„æœªä½¿ç”¨

### ğŸ§  å†…å­˜ä¸ä¸Šä¸‹æ–‡ç®¡ç†

| ç‰¹æ€§ | æè¿° |
|------|------|
| **æ™ºèƒ½å‹ç¼©ç®—æ³•** | å½“ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡è¾¾åˆ°92%é˜ˆå€¼æ—¶è‡ªåŠ¨è§¦å‘å‹ç¼©ï¼Œä¿ç•™å…³é”®ä¿¡æ¯ |
| **é‡è¦æ€§è¯„åˆ†** | åŸºäºæ¶ˆæ¯è§’è‰²ã€ä½ç½®ã€å…³é”®è¯ç­‰å¤šç»´åº¦è¯„åˆ†ï¼Œæ™ºèƒ½ç­›é€‰ä¿ç•™å†…å®¹ |
| **åˆ†å±‚å­˜å‚¨** | Hot(æ´»è·ƒ) â†’ Warm(è¿‘æœŸ) â†’ Cold(å½’æ¡£) ä¸‰å±‚å­˜å‚¨æœºåˆ¶ |
| **Tokenä¼˜åŒ–** | åŠ¨æ€ä¸Šä¸‹æ–‡çª—å£è°ƒæ•´ï¼Œæœ€å¤§åŒ–åˆ©ç”¨æ¨¡å‹ä¸Šä¸‹æ–‡èƒ½åŠ› `ã€éƒ¨åˆ†å®ç°ã€‘`ï¼ˆå½“å‰ä¸ºå›ºå®šä¸Šé™ + å‹ç¼©è§¦å‘ï¼Œæœªå®ç°æŒ‰æ¨¡å‹èƒ½åŠ›åŠ¨æ€æ‰©ç¼©å®¹ï¼‰ |
| **å†å²æ‘˜è¦** | å¯¹å‹ç¼©çš„å†å²å¯¹è¯ç”Ÿæˆæ™ºèƒ½æ‘˜è¦ï¼Œä¿ç•™ä¸Šä¸‹æ–‡è¿è´¯æ€§ |

### ğŸ”„ Agentå¾ªç¯ç³»ç»Ÿ

| ç‰¹æ€§ | æè¿° |
|------|------|
| **å¼‚æ­¥æ ¸å¿ƒè°ƒåº¦å™¨** | åŸºäºasyncioçš„å¼‚æ­¥æ¶æ„ï¼Œæ”¯æŒå¹¶å‘å¤„ç†å¤šä¸ªä¼šè¯ `ã€æœªæ¥å…¥ä¸»é“¾è·¯ã€‘`ï¼ˆå½“å‰ `/chat` ä¸ `/chat/stream` ç›´æ¥èµ° `ChatAgent` è°ƒç”¨é“¾ï¼‰ |
| **ä¸­æ–­å’Œæ¢å¤** | æ”¯æŒä¸­æ–­æ­£åœ¨è¿›è¡Œçš„å¯¹è¯ï¼Œå¯ä»æ£€æŸ¥ç‚¹æ¢å¤æ‰§è¡Œ `ã€éƒ¨åˆ†å®ç°ã€‘`ï¼ˆå·²æœ‰ä¸­æ–­æ ‡è®°ä¸æ£€æŸ¥ç‚¹å†™å…¥ï¼Œæœªå®ç°æ£€æŸ¥ç‚¹æ¢å¤æ‰§è¡Œï¼‰ |
| **æ£€æŸ¥ç‚¹æœºåˆ¶** | å®šæœŸä¿å­˜æ‰§è¡ŒçŠ¶æ€ï¼Œå¼‚å¸¸æ—¶å¯æ¢å¤ `ã€éƒ¨åˆ†å®ç°ã€‘`ï¼ˆå·²ä¿å­˜æ£€æŸ¥ç‚¹ï¼Œæœªæä¾›æ¢å¤ API / è‡ªåŠ¨æ¢å¤æµç¨‹ï¼‰ |
| **å¤šå±‚å¼‚å¸¸å¤„ç†** | å®Œå–„çš„é”™è¯¯æ•è·å’Œæ¢å¤æœºåˆ¶ï¼Œä¿è¯ç³»ç»Ÿç¨³å®šæ€§ |
| **å·¥å…·è°ƒç”¨** | æ”¯æŒå¹¶è¡Œå·¥å…·æ‰§è¡Œï¼Œå¯æ‰©å±•è‡ªå®šä¹‰å·¥å…· |

### ä»»åŠ¡è¿›åº¦è¿½è¸ªï¼ˆTodosï¼‰

ä½œä¸º`tools`ç¼–æ’åœ¨å·¥å…·é‡Œ

| ç‰¹æ€§ | æè¿° |
|------|------|
| **LLM è‡ªä¸»å†³ç­–å¼€å¯** | é€šè¿‡ system prompt æ³¨å…¥ + `manage_todo_list` å·¥å…·ï¼ŒLLM è‡ªè¡Œåˆ¤æ–­ä½•æ—¶å¯ç”¨å¤šæ­¥éª¤ä»»åŠ¡è¿½è¸ª |
| **ä¸‰æ€æ­¥éª¤ç®¡ç†** | æ¯ä¸ªæ­¥éª¤æ”¯æŒ `pending` â†’ `running` â†’ `completed` ä¸‰æ€æµè½¬ï¼ŒåŒä¸€æ—¶é—´æœ€å¤šä¸€ä¸ª `running` |
| **SSE å®æ—¶æ¨é€** | æ¯æ¬¡ todo å˜æ›´è‡ªåŠ¨é€šè¿‡ SSE æ¨é€å®Œæ•´å¿«ç…§ï¼ˆ`type="todo_list"`ï¼‰ï¼Œå‰ç«¯æ— éœ€è½®è¯¢ |
| **PostgreSQL æŒä¹…åŒ–** | ç‹¬ç«‹ä¸¤å¼ è¡¨ï¼ˆ`session_todo_lists` / `session_todo_items`ï¼‰+ ä¹è§‚é” revisionï¼Œæ”¯æŒé¡µé¢åˆ·æ–°æ¢å¤ |
| **REST æ¢å¤ç«¯ç‚¹** | `GET /sessions/{id}/todo-list` ä¾›å‰ç«¯åˆ·æ–°æ—¶ä¸€æ¬¡æ€§æ‹‰å–æœ€æ–° todo çŠ¶æ€ |
| **ä¸æ™®é€šä¼šè¯å…¼å®¹** | æ—  todo çš„ä¼šè¯ä¸å—å½±å“ï¼Œtodo ä¸ºå¯é€‰é™„åŠ èƒ½åŠ›ï¼Œä¸æ”¹å˜åŸæœ‰å¯¹è¯é“¾è·¯ |

### æ¶ˆæ¯å¤„ç†ç®¡é“

| ç‰¹æ€§ | æè¿° |
|------|------|
| **ä¼˜å…ˆçº§é˜Ÿåˆ—** | æ”¯æŒæ¶ˆæ¯ä¼˜å…ˆçº§è°ƒåº¦ï¼Œç´§æ€¥æ¶ˆæ¯ä¼˜å…ˆå¤„ç† |
| **å¤šåç«¯æ”¯æŒ** | Memory(å†…å­˜) / Redis / Kafka ä¸‰ç§åç«¯å¯é€‰ |
| **ä¸­é—´ä»¶ç³»ç»Ÿ** | å†…ç½®æ—¥å¿—ã€è®¡æ—¶ã€é‡è¯•ã€é™æµç­‰ä¸­é—´ä»¶ï¼Œå¯è‡ªå®šä¹‰æ‰©å±• |
| **æ¶ˆæ¯TTL** | æ”¯æŒæ¶ˆæ¯è¿‡æœŸæ—¶é—´è®¾ç½® `ã€æœªå®ç°ã€‘`ï¼ˆé…ç½®é¡¹å·²å­˜åœ¨ï¼Œæ¶ˆè´¹è·¯å¾„æœªæ‰§è¡Œ TTL è¿‡æœŸè£å‰ªï¼‰ |

### ğŸ’» å‰ç«¯ç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| **æ€è€ƒæ¨¡å¼å±•ç¤º** | AIæ€è€ƒè¿‡ç¨‹ç½®ç°æ˜¾ç¤ºï¼Œæ€è€ƒç»“æŸåå¯æŠ˜å å±•å¼€ |
| **æµå¼å“åº”** | å®æ—¶æ˜¾ç¤ºAIå›å¤ï¼Œæ‰“å­—æœºæ•ˆæœ |
| **å¯¹è¯ç®¡ç†** | ç‹¬ç«‹ä¼šè¯IDç®¡ç†ï¼Œæ”¯æŒå¤šä¼šè¯åˆ‡æ¢ |
| **è‡ªåŠ¨æ ‡é¢˜** | å¯¹è¯å¼€å§‹æ—¶è‡ªåŠ¨ç”Ÿæˆä¸»é¢˜æ ‡é¢˜ |
| **Markdownæ¸²æŸ“** | æ”¯æŒä»£ç é«˜äº®ã€è¡¨æ ¼ã€åˆ—è¡¨ç­‰å¯Œæ–‡æœ¬å±•ç¤º |
| **å“åº”å¼è®¾è®¡** | é€‚é…æ¡Œé¢å’Œç§»åŠ¨ç«¯ |

### ğŸ ä»£ç æ‰§è¡Œæ²™ç®±ï¼ˆCode Sandboxï¼‰

| ç‰¹æ€§ | æè¿° |
|------|------|
| **Docker å®¹å™¨éš”ç¦»** | æ¯æ¬¡ä»£ç æ‰§è¡Œåœ¨ç‹¬ç«‹ Docker å®¹å™¨ä¸­è¿è¡Œï¼Œæä¾› OS çº§å®‰å…¨éš”ç¦» |
| **èµ„æºé™åˆ¶** | CPUï¼ˆ50% å•æ ¸ï¼‰ã€å†…å­˜ï¼ˆ256 MBï¼‰ã€PIDï¼ˆ64ï¼‰ã€æ‰§è¡Œæ—¶é—´ï¼ˆ30sï¼‰ä¸¥æ ¼é™åˆ¶ |
| **é¢„è£…ç§‘å­¦è®¡ç®—åº“** | é•œåƒå†…ç½® numpy / pandas / matplotlib / sympy / scipy / requests |
| **AST å®‰å…¨é¢„æ£€** | æ‰§è¡Œå‰é™æ€åˆ†æï¼Œæ‹¦æˆª fork bomb ç­‰èµ„æºè€—å°½æ¨¡å¼ï¼Œé¢„è­¦é«˜é£é™©æ“ä½œ |
| **ç½‘ç»œéš”ç¦»** | é»˜è®¤ç¦ç”¨å®¹å™¨ç½‘ç»œï¼Œå¯æŒ‰éœ€å¼€å¯ |
| **è¾“å‡ºæ•è·ä¸æˆªæ–­** | å®Œæ•´æ•è· stdout / stderrï¼Œè¶…è¿‡ 64 KB è‡ªåŠ¨æˆªæ–­ |
| **å³ç”¨å³é”€** | æ¯æ¬¡æ‰§è¡Œåˆ›å»ºä¸€æ¬¡æ€§å®¹å™¨ï¼Œæ‰§è¡Œå®Œæ¯•ç«‹å³é”€æ¯ï¼Œæ— çŠ¶æ€æ®‹ç•™ |

---

## 3 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Vue3 Frontend                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ChatWindowâ”‚  â”‚ChatMessageâ”‚ â”‚ChatInput â”‚  â”‚ChatSidebarâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â–¼              â–¼                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â”‚   Pinia Store (State)    â”‚                       â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP/SSE
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FastAPI Backend                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    API Layer                              â”‚   â”‚
â”‚  â”‚  /chat/  /chat/stream  /sessions/  /chat/title           â”‚   â”‚
â”‚  â”‚  /sessions/{id}/todo-list                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   ChatAgent Core                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚ Agent Loop  â”‚  â”‚Tool Executorâ”‚  â”‚Memory Managerâ”‚      â”‚   â”‚
â”‚  â”‚  â”‚(Async Sched)â”‚  â”‚ (Parallel)  â”‚  â”‚(Compress 92%)â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚               Message Pipeline & Queue                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚Middlewareâ”‚â†’ â”‚Priority Qâ”‚â†’ â”‚  Handler â”‚               â”‚   â”‚
â”‚  â”‚  â”‚(Log/Retry)â”‚  â”‚(Redis/Kafka)â”‚ â”‚          â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             Code Execution Sandbox (Docker)               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Security â”‚â†’ â”‚   Container   â”‚â†’ â”‚ Output Capture   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚(AST Check)â”‚  â”‚(CPU/Mem/PID)  â”‚  â”‚(stdout/stderr)   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ OpenAI API
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   OpenAI /      â”‚
                   â”‚   Compatible APIâ”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4 Quick Start

**0. ç¯å¢ƒè¦æ±‚**

- **åç«¯**: Python 3.12+
- **å‰ç«¯**: Node.js 18+ / Bun
- **ä»£ç æ²™ç®±**: Docker Engine 20.10+
- **å¯é€‰**: Redis 7+ (ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—), Kafka (ç”¨äºå¤§è§„æ¨¡éƒ¨ç½²)

**1. åç«¯å¯åŠ¨**

```bash
# è¿›å…¥åç«¯ç›®å½•
cd agent-backend

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate     # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„é…ç½®
# OPENAI_API_KEY=your-api-key-here
# OPENAI_BASE_URL=https://api.openai.com/v1

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
uvicorn app.main:app --reload --port 8000

# æˆ–ç”Ÿäº§æ¨¡å¼
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

**2. å‰ç«¯å¯åŠ¨**

```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd agent-frontend

# å®‰è£…ä¾èµ–
npm install
# æˆ–ä½¿ç”¨ pnpm
pnpm install
# æˆ–ä½¿ç”¨ bun
bun install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build
```

**3. è®¿é—®åº”ç”¨**

- **å‰ç«¯ç•Œé¢**: http://localhost:5173
- **APIæ–‡æ¡£ (Swagger)**: http://localhost:8000/docs
- **APIæ–‡æ¡£ (ReDoc)**: http://localhost:8000/redoc

---

## 5 æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1) Memory Management

#### æ™ºèƒ½å‹ç¼©ç®—æ³•

å½“ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡è¾¾åˆ°92%é˜ˆå€¼æ—¶è‡ªåŠ¨è§¦å‘å‹ç¼©ï¼š

```python
# å‹ç¼©è§¦å‘æ¡ä»¶
def should_compress(self, messages: list[Message], max_tokens: int) -> bool:
    total_tokens = sum(m.token_count for m in messages)
    usage_ratio = total_tokens / max_tokens
    return usage_ratio >= 0.92  # 92% é˜ˆå€¼
```

#### é‡è¦æ€§è¯„åˆ†

åŸºäºå¤šç»´åº¦è¯„åˆ†å†³å®šæ¶ˆæ¯ä¿ç•™ä¼˜å…ˆçº§ï¼š

```python
def score(self, message: Message, position: int, total: int) -> float:
    # ä½ç½®å› å­ (æœ€è¿‘çš„æ¶ˆæ¯æ›´é‡è¦)
    position_factor = self.decay_factor ** (total - position - 1)
    
    # è§’è‰²æƒé‡ (system > user > assistant > tool)
    role_weights = {
        MessageRole.SYSTEM: 1.0,
        MessageRole.USER: 0.8,
        MessageRole.ASSISTANT: 0.6,
        MessageRole.TOOL: 0.5,
    }
    
    # å…³é”®è¯åˆ†æ
    keyword_score = self._analyze_keywords(message.content)
    
    # å·¥å…·è°ƒç”¨åŠ æˆ
    tool_bonus = 0.2 if message.tool_calls else 0.0
    
    return weighted_sum(...)
```

#### åˆ†å±‚å­˜å‚¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Hot Layer                    â”‚
â”‚  - å½“å‰æ´»è·ƒå¯¹è¯                              â”‚
â”‚  - å®Œæ•´æ¶ˆæ¯å†…å®¹                              â”‚
â”‚  - æœ€é«˜ä¼˜å…ˆçº§                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Warm Layer                    â”‚
â”‚  - è¿‘æœŸå†å²å¯¹è¯                              â”‚
â”‚  - å¯å¿«é€Ÿæ¢å¤                                â”‚
â”‚  - ä¸­ç­‰ä¼˜å…ˆçº§                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Cold Layer                    â”‚
â”‚  - å½’æ¡£å†å²                                  â”‚
â”‚  - ä»…ä¿ç•™æ‘˜è¦                                â”‚
â”‚  - ä½ä¼˜å…ˆçº§                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2) Agent Main Loop

#### å¼‚æ­¥è°ƒåº¦å™¨

```python
class AgentLoop:
    async def _main_loop(self) -> None:
        """ä¸»å¤„ç†å¾ªç¯"""
        while not self._stop_event.is_set():
            # æ£€æŸ¥æš‚åœ
            if self._pause_event.is_set():
                await asyncio.sleep(0.1)
                continue
            
            # è·å–ä¸‹ä¸€æ¡æ¶ˆæ¯
            message = await self.queue.dequeue(timeout=1.0)
            if message:
                # å¼‚æ­¥å¤„ç†
                task = asyncio.create_task(
                    self._process_message(message)
                )
                self._tasks[message.session_id] = task
```

#### ä¸­æ–­å’Œæ¢å¤

```python
# ä¸­æ–­ä¼šè¯
async def interrupt(self, session_id: UUID) -> bool:
    if session_id in self._interrupt_events:
        self._interrupt_events[session_id].set()
        self._agent_states[session_id].status = MessageStatus.INTERRUPTED
        return True
    return False

# æ£€æŸ¥ç‚¹æ¢å¤
async def _create_checkpoint(self, session_id: UUID, state: AgentState):
    checkpoint = Checkpoint(
        id=state.session_id,
        iteration=state.iteration,
        state={"status": state.status.value},
        messages=list(session.messages)
    )
    self._checkpoints[session_id].append(checkpoint)
```

> ğŸ·ï¸ `ã€éƒ¨åˆ†å®ç°ã€‘` å½“å‰åç«¯å·²å®ç°â€œä¸­æ–­æ ‡è®° + æ£€æŸ¥ç‚¹å†™å…¥â€ï¼Œä½†å°šæœªå®ç°â€œä»æ£€æŸ¥ç‚¹æ¢å¤ç»§ç»­æ‰§è¡Œâ€çš„å®Œæ•´æµç¨‹ï¼ˆåŒ…æ‹¬æ¢å¤å…¥å£ã€çŠ¶æ€å›æ”¾ã€é‡å…¥æ‰§è¡Œï¼‰ã€‚

### 3) Message Pipeline

#### ä¸­é—´ä»¶ç³»ç»Ÿ

```python
# å†…ç½®ä¸­é—´ä»¶
pipeline = (
    MessagePipeline()
    .use(LoggingMiddleware())      # æ—¥å¿—è®°å½•
    .use(TimingMiddleware())       # æ€§èƒ½è®¡æ—¶
    .use(ValidationMiddleware())   # æ•°æ®éªŒè¯
    .use(RetryMiddleware(max_retries=3))  # é‡è¯•æœºåˆ¶
    .use(RateLimitMiddleware(rps=10.0))   # é™æµ
)
```

> ğŸ·ï¸ `ã€æœªå®ç°ã€‘` `QUEUE_MESSAGE_TTL` å·²åœ¨é…ç½®ä¸­å®šä¹‰ï¼Œä½†å½“å‰é˜Ÿåˆ— `enqueue/dequeue` ä¸»è·¯å¾„æœªä¾æ® TTL è¿›è¡Œè¿‡æœŸè¿‡æ»¤ã€‚

### 4) Tool SPI æ³¨å†Œä¸å‘ç°ï¼ˆæ ¸å¿ƒå®ç°ï¼‰

#### æ³¨å†Œè°ƒç”¨é“¾ï¼ˆåç«¯çœŸå®æ‰§è¡Œè·¯å¾„ï¼‰

æ¡†æ¶å¯åŠ¨åï¼Œå·¥å…·æ³¨å†Œé“¾è·¯å¦‚ä¸‹ï¼š

1. `ChatAgent.__init__` è°ƒç”¨ `create_default_executor()`
2. `app.agent.executor.create_default_executor()` è½¬è°ƒ `app.agent.tools.register.create_default_executor()`
3. `register.create_default_executor()` åˆ›å»º `ToolExecutor`ï¼Œå¹¶æ‰§è¡Œ `register_default_tools(executor)`
4. `register_default_tools()` è¯»å– `settings.tools.*`ï¼Œè°ƒç”¨ `register_discovered_tools(...)`
5. `register_discovered_tools()` å†…éƒ¨è°ƒç”¨ `discover_tools(...)` å®Œæˆå‘ç°ï¼Œå†é€ä¸ª `executor.register_tool(tool)`

è¿™æ„å‘³ç€ï¼š**å·¥å…·å‘ç°å‘ç”Ÿåœ¨ Agent åˆå§‹åŒ–é˜¶æ®µ**ï¼Œä¸æ˜¯æ¯æ¬¡è¯·æ±‚åŠ¨æ€å‘ç°ã€‚

#### å‘ç°ç­–ç•¥ç»†èŠ‚

`discover_tools(...)` åŒæ—¶æ”¯æŒä¸¤ç±»æ¥æºï¼š

- Built-inï¼šéå† `app.agent.tools.internal` åŒ…
    - ä½¿ç”¨ `pkgutil.walk_packages` é€’å½’æ‰«ææ¨¡å—
    - ä½¿ç”¨ `inspect.getmembers(..., inspect.isclass)` æ”¶é›†ç±»
    - ä»…ä¿ç•™â€œå®šä¹‰åœ¨å½“å‰æ¨¡å—ä¸­ + `BaseTool` å­ç±» + éæŠ½è±¡ç±»â€
    - é€šè¿‡æ— å‚æ„é€ å®ä¾‹åŒ–

- Entry Pointsï¼ˆSPIï¼‰ï¼šè¯»å– `importlib.metadata.entry_points(group=...)`
    - å¯¹æ¯ä¸ª entry point è°ƒç”¨ `ep.load()`
    - å…è®¸ä»¥ä¸‹è¿”å›å½¢æ€ï¼ˆä¼šè¢«ç»Ÿä¸€è½¬æ¢ï¼‰ï¼š
        - `BaseTool` å­ç±»
        - `BaseTool` å®ä¾‹
        - å·¥å‚å‡½æ•°ï¼ˆè¿”å›ä¸Šè¿°å¯¹è±¡ï¼‰
        - å¯è¿­ä»£å¯¹è±¡ï¼ˆå…ƒç´ å¯é€’å½’ä¸ºä¸Šè¿°ä»»æ„å½¢æ€ï¼‰

#### é‡åå†²çªä¸å¼‚å¸¸ç­–ç•¥

- é‡åå·¥å…·ï¼ˆåŒ `tool.name`ï¼‰å¤„ç†ï¼š**å…ˆåˆ°å…ˆå¾—**ï¼Œåç»­åŒåå·¥å…·ä¼šè¢«å¿½ç•¥å¹¶è®°å½• warning æ—¥å¿—
- å‘ç°å¼‚å¸¸å¤„ç†ï¼š
    - `TOOLS_DISCOVERY_FAIL_FAST=false`ï¼šè®°å½• error æ—¥å¿—å¹¶è·³è¿‡å¤±è´¥æä¾›æ–¹
    - `TOOLS_DISCOVERY_FAIL_FAST=true`ï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯åŠ¨å¤±è´¥ï¼ˆé€‚åˆå¼ºä¸€è‡´ç”Ÿäº§ç¯å¢ƒï¼‰

#### ç¯å¢ƒå˜é‡ä¸è¡Œä¸ºæ˜ å°„

```env
TOOLS_ENABLE_BUILTIN_DISCOVERY=true        # æ˜¯å¦æ‰«æå†…ç½®å·¥å…·åŒ…
TOOLS_ENABLE_ENTRYPOINT_DISCOVERY=true     # æ˜¯å¦å¯ç”¨ entry points å‘ç°
TOOLS_ENTRYPOINT_GROUP=chat_agent_framework.tools
TOOLS_DISCOVERY_FAIL_FAST=false            # å•ä¸ª provider å¤±è´¥æ—¶æ˜¯å¦ç›´æ¥å¤±è´¥
```

#### ç¬¬ä¸‰æ–¹æ’ä»¶æ¥å…¥çº¦æŸï¼ˆå®è·µå»ºè®®ï¼‰

- entry point æ¨èæŒ‡å‘**æ— çŠ¶æ€å·¥å…·ç±»**æˆ–**è½»é‡å·¥å‚å‡½æ•°**
- å·¥å…· `name` å¿…é¡»å…¨å±€å”¯ä¸€ï¼ˆå»ºè®®ä½¿ç”¨å‰ç¼€ï¼Œå¦‚ `weather.query`ï¼‰
- `execute(**kwargs)` ä¸­é¿å…é•¿é˜»å¡ï¼›éœ€è¦ç½‘ç»œ I/O æ—¶å¿…é¡»å¼‚æ­¥åŒ–
- ä¿è¯ `parameters` ä¸å®é™…å‡½æ•°å‚æ•°è¯­ä¹‰ä¸€è‡´ï¼Œé¿å…æ¨¡å‹æ„é€ éæ³•å‚æ•°

#### è¿è¡Œæ—¶æ’éšœæ¸…å•

å½“å·¥å…·æœªç”Ÿæ•ˆæ—¶ï¼Œä¼˜å…ˆæ£€æŸ¥ï¼š

1. æ’ä»¶åŒ…æ˜¯å¦å®‰è£…åˆ°**å½“å‰è¿è¡Œç¯å¢ƒ**
2. `TOOLS_ENTRYPOINT_GROUP` æ˜¯å¦ä¸æ’ä»¶å£°æ˜ä¸€è‡´
3. å·¥å…·åæ˜¯å¦ä¸ç°æœ‰å·¥å…·å†²çªï¼ˆå†²çªæ—¶ååŠ è½½è€…ä¼šè¢«å¿½ç•¥ï¼‰
4. `TOOLS_DISCOVERY_FAIL_FAST` æ˜¯å¦å¯¼è‡´å¯åŠ¨ç›´æ¥å¤±è´¥
5. å¯åŠ¨æ—¥å¿—ä¸­æ˜¯å¦å‡ºç° `Tool discovery completed` / `External tool entry point failed`

### 5) ä»£ç æ‰§è¡Œæ²™ç®± â€” Code Sandboxï¼ˆæ ¸å¿ƒå®ç°ï¼‰

ä»£ç æ‰§è¡Œæ²™ç®±å…è®¸ Agentï¼ˆLLMï¼‰åœ¨å¯¹è¯è¿‡ç¨‹ä¸­è‡ªä¸»ç¼–å†™å¹¶è¿è¡Œ Python ä»£ç ï¼Œè·å–çœŸå®è®¡ç®—ç»“æœã€‚è¿™ä¸ ChatGPT Code Interpreter / Claude Analysis çš„èƒ½åŠ›å¯¹é½ã€‚

#### ä¸šç•Œæœ€ä½³å®è·µï¼šä¸ºä»€ä¹ˆæ˜¯ Dockerï¼Ÿ

| æ–¹æ¡ˆ | éš”ç¦»çº§åˆ« | å®‰å…¨æ€§ | åŒ…ç®¡ç† | ç”Ÿäº§å°±ç»ª | ä»£è¡¨äº§å“ |
|------|----------|--------|--------|----------|----------|
| `eval()` / `exec()` | æ—  | âŒ æå±é™© | âŒ | âŒ | â€” |
| RestrictedPython | å‡½æ•°çº§ | âš ï¸ æ˜“ç»•è¿‡ | âŒ | âŒ | â€” |
| subprocess + venv | è¿›ç¨‹çº§ | âš ï¸ ä¸­ç­‰ | âœ… | âš ï¸ | â€” |
| **Docker å®¹å™¨** | **OS çº§** | **âœ… å·¥ä¸šçº§** | **âœ…** | **âœ…** | **ChatGPT / Claude / Gemini** |
| Firecracker microVM | VM çº§ | âœ… æœ€å¼º | âœ… | âœ… | AWS Lambda |

**Docker å®¹å™¨æ˜¯ Agent ä»£ç æ‰§è¡Œçš„è¡Œä¸šæ ‡å‡†**ã€‚ChatGPT Code Interpreterã€Claude Analysisã€Gemini Code Execution åº•å±‚å‡ä½¿ç”¨å®¹å™¨åŒ–æ–¹æ¡ˆã€‚æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. **å‘½åç©ºé—´éš”ç¦»**ï¼šè¿›ç¨‹ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€IPC å®Œå…¨éš”ç¦»ï¼Œå³ä½¿ä»£ç å°è¯• `os.system("rm -rf /")` ä¹Ÿåªå½±å“å®¹å™¨å†…éƒ¨
2. **cgroup èµ„æºé™åˆ¶**ï¼šCPUã€å†…å­˜ã€PID æ•°é‡å‡å¯ç²¾ç¡®æ§åˆ¶ï¼Œé˜²æ­¢èµ„æºè€—å°½æ”»å‡»
3. **å³ç”¨å³é”€**ï¼šæ¯æ¬¡æ‰§è¡Œåˆ›å»ºå…¨æ–°å®¹å™¨ï¼Œæ‰§è¡Œåç«‹å³é”€æ¯ï¼Œæ— çŠ¶æ€æ³„æ¼
4. **å¯å¤ç°ç¯å¢ƒ**ï¼šé¢„æ„å»ºé•œåƒç¡®ä¿æ¯æ¬¡æ‰§è¡Œç¯å¢ƒä¸€è‡´
5. **ç”Ÿæ€æˆç†Ÿ**ï¼šDocker SDKã€é•œåƒç®¡ç†ã€æ—¥å¿—æ”¶é›†ç­‰å·¥å…·é“¾å®Œå–„

#### æ¶æ„æ€»è§ˆ

```
app/sandbox/                          sandbox/
â”œâ”€â”€ __init__.py                       â”œâ”€â”€ Dockerfile          # æ²™ç®±é•œåƒå®šä¹‰
â”œâ”€â”€ models.py     # æ•°æ®æ¨¡å‹           â””â”€â”€ requirements.txt    # é¢„è£…åŒ…åˆ—è¡¨
â”œâ”€â”€ security.py   # AST å®‰å…¨é¢„æ£€
â”œâ”€â”€ manager.py    # Docker å®¹å™¨ç®¡ç†
â””â”€â”€ executor.py   # é«˜å±‚æ‰§è¡Œæ¥å£

app/agent/tools/internal/
â””â”€â”€ python_executor.py  # BaseTool å®ç°ï¼ˆè‡ªåŠ¨è¢« SPI å‘ç°æ³¨å†Œï¼‰
```

#### æ‰§è¡Œæµç¨‹ï¼ˆç«¯åˆ°ç«¯ï¼‰

```
ç”¨æˆ·: "å¸®æˆ‘è®¡ç®— fibonacci(50) çš„å€¼"
  â”‚
  â–¼
LLM å†³å®šè°ƒç”¨ python_executor å·¥å…·
  â”‚  {"code": "def fib(n):\n    a, b = 0, 1\n    for _ in range(n):\n        a, b = b, a+b\n    return a\nprint(fib(50))"}
  â”‚
  â–¼
PythonExecutorTool.execute(code)
  â”‚
  â”œâ”€ â‘  SecurityChecker.validate(code)
  â”‚     â”œâ”€ AST è§£æ â†’ è¯­æ³•æ£€æŸ¥
  â”‚     â”œâ”€ æ¨¡å—é»‘åå•æ£€æŸ¥ï¼ˆctypes / multiprocessing / signalï¼‰
  â”‚     â”œâ”€ å±é™©è°ƒç”¨é¢„è­¦ï¼ˆos.system ç­‰ â†’ ä»… warnï¼Œä¸ blockï¼‰
  â”‚     â””â”€ é€šè¿‡ âœ… / æ‹’ç» âŒ
  â”‚
  â”œâ”€ â‘¡ DockerSandboxManager.execute(request)
  â”‚     â”œâ”€ åˆ›å»ºä¸€æ¬¡æ€§å®¹å™¨ï¼ˆimage: agent-sandbox:latestï¼‰
  â”‚     â”‚     CPU: 50% å•æ ¸ | å†…å­˜: 256MB | PID: 64 | ç½‘ç»œ: ç¦ç”¨
  â”‚     â”œâ”€ é€šè¿‡ tar archive æ³¨å…¥ä»£ç  â†’ /workspace/main.py
  â”‚     â”œâ”€ å¯åŠ¨å®¹å™¨, python -u /workspace/main.py
  â”‚     â”œâ”€ asyncio.wait_for(container.wait(), timeout=30s)
  â”‚     â”œâ”€ æ•è· stdout / stderr (â‰¤ 64KB)
  â”‚     â””â”€ force remove å®¹å™¨
  â”‚
  â–¼
ExecutionResult â†’ æ ¼å¼åŒ–è¿”å›ç»™ LLM
  â”‚  "STDOUT:\n12586269025\n\nExecution time: 0.03s"
  â”‚
  â–¼
LLM ç»„ç»‡è‡ªç„¶è¯­è¨€å›å¤ç»™ç”¨æˆ·
```

#### å®‰å…¨æ¨¡å‹ï¼ˆDefense in Depthï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: AST é™æ€åˆ†æï¼ˆSecurityCheckerï¼‰                â”‚
â”‚  â€¢ è¯­æ³•æ£€æŸ¥ï¼ˆå¿«é€Ÿå¤±è´¥ï¼Œé¿å…æµªè´¹å®¹å™¨èµ„æºï¼‰                  â”‚
â”‚  â€¢ é˜»æ­¢ï¼šctypes / multiprocessing / signal               â”‚
â”‚  â€¢ é¢„è­¦ï¼šos.system / subprocess / evalï¼ˆä»…æ—¥å¿—è®°å½•ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: Docker å®¹å™¨éš”ç¦»                                â”‚
â”‚  â€¢ ç‹¬ç«‹ PID / Mount / Network / IPC namespace            â”‚
â”‚  â€¢ é root ç”¨æˆ· (sandbox)                                â”‚
â”‚  â€¢ security_opt: no-new-privileges                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: cgroup èµ„æºé™åˆ¶                                â”‚
â”‚  â€¢ CPU: 50% å•æ ¸ (cpu_quota / cpu_period)                â”‚
â”‚  â€¢ å†…å­˜: 256 MB (OOM Kill)                               â”‚
â”‚  â€¢ PID: 64 (é˜²æ­¢ fork bomb)                              â”‚
â”‚  â€¢ æ‰§è¡Œæ—¶é—´: 30s (asyncio è¶…æ—¶ â†’ container.kill)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 4: ç½‘ç»œéš”ç¦»                                       â”‚
â”‚  â€¢ é»˜è®¤ network_disabled=true                            â”‚
â”‚  â€¢ å¯æŒ‰è¯·æ±‚ä¸´æ—¶å¼€å¯ï¼ˆéœ€è¦ pip install æ—¶ï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 5: è¾“å‡ºæ§åˆ¶                                       â”‚
â”‚  â€¢ stdout / stderr æˆªæ–­ä¸Šé™: 64 KB                       â”‚
â”‚  â€¢ å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ‰§è¡Œåé”€æ¯ï¼Œæ— æŒä¹…åŒ–                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®¹å™¨ç”Ÿå‘½å‘¨æœŸ

```
                 create          start        wait/timeout    logs       remove
                   â”‚               â”‚               â”‚           â”‚           â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Request â”‚â”€â”€â–¶â”‚  Container  â”‚â–¶â”‚  Running   â”‚â–¶â”‚ Exited / â”‚â–¶â”‚ Output  â”‚â–¶â”‚ Destroyed â”‚
  â”‚(code)   â”‚   â”‚  Created    â”‚ â”‚ (python    â”‚ â”‚ Timeout  â”‚ â”‚ Capture â”‚ â”‚ (force rm)â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  (detach)   â”‚ â”‚  main.py)  â”‚ â”‚ (killed) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  tar inject â†—
                 (put_archive)
```

ä»£ç æ³¨å…¥æ–¹å¼ï¼šä¸ä½¿ç”¨ Volume Mountï¼ˆæœ‰å®‰å…¨é£é™©ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ `container.put_archive()` å°†ä»£ç æ‰“åŒ…ä¸º tar å†™å…¥å®¹å™¨å†… `/workspace/main.py`ï¼Œå®ç°é›¶å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿæš´éœ²ã€‚

#### Docker é•œåƒè®¾è®¡

æ²™ç®±é•œåƒå®šä¹‰åœ¨ `sandbox/Dockerfile`ï¼š

```dockerfile
FROM python:3.12-slim

# é root ç”¨æˆ·
RUN groupadd -r sandbox && useradd -r -g sandbox -m -s /bin/bash sandbox

# é¢„è£…ç§‘å­¦è®¡ç®—åŒ…
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# å·¥ä½œç›®å½•
RUN mkdir -p /workspace && chown sandbox:sandbox /workspace
WORKDIR /workspace
USER sandbox

CMD ["python", "-u", "/workspace/main.py"]
```

é¢„è£…åŒ…åˆ—è¡¨ï¼ˆ`sandbox/requirements.txt`ï¼‰ï¼š
- **è®¡ç®—**: numpy, pandas, scipy, sympy
- **å¯è§†åŒ–**: matplotlib
- **å·¥å…·**: requests, python-dateutil, tabulate, pyyaml

#### åŒ…å®‰è£…ç­–ç•¥

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|----------|
| ä½¿ç”¨é¢„è£…åŒ… (numpy ç­‰) | ç›´æ¥ importï¼Œé›¶å»¶è¿Ÿ |
| éœ€è¦é¢å¤–åŒ… | LLM ä¼ å…¥ `install_packages` å‚æ•° â†’ å®¹å™¨å†… `pip install -q` â†’ éœ€å¼€å¯ç½‘ç»œ |
| å®‰è£…å¤±è´¥ | stderr è¿”å›é”™è¯¯ä¿¡æ¯ï¼ŒLLM å¯è‡ªè¡Œè°ƒæ•´ |

#### å…³é”®å®ç°ç»†èŠ‚

**1. å¼‚æ­¥ Docker è°ƒç”¨**

Docker SDK æ˜¯åŒæ­¥çš„ï¼Œé€šè¿‡ `asyncio.to_thread()` åŒ…è£…ä¿æŒäº‹ä»¶å¾ªç¯å“åº”ï¼š

```python
# manager.py â€” æ‰€æœ‰ Docker æ“ä½œå‡ offload åˆ°çº¿ç¨‹æ± 
container = await asyncio.to_thread(self._create_container, request)
await asyncio.to_thread(self._copy_code_to_container, container, script)
await asyncio.to_thread(container.start)
exit_info = await asyncio.wait_for(
    asyncio.to_thread(container.wait),
    timeout=request.timeout,   # asyncio å±‚è¶…æ—¶ â†’ container.kill()
)
```

**2. è¶…æ—¶å¤„ç†åŒä¿é™©**

```
asyncio.wait_for(timeout=30s)     â† åº”ç”¨å±‚è¶…æ—¶ï¼ˆé¦–é€‰ï¼‰
         â”‚ TimeoutError
         â–¼
container.kill()                   â† å¼ºåˆ¶ç»ˆæ­¢å®¹å™¨è¿›ç¨‹
container.remove(force=True)       â† æ¸…ç†å®¹å™¨ï¼ˆfinally å—ä¿è¯æ‰§è¡Œï¼‰
```

**3. SPI è‡ªåŠ¨æ³¨å†Œ**

`PythonExecutorTool` æ”¾ç½®åœ¨ `app/agent/tools/internal/` åŒ…ä¸­ï¼Œæ¡†æ¶å¯åŠ¨æ—¶è¢« `discover_tools()` è‡ªåŠ¨æ‰«ææ³¨å†Œï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚

#### ä¸ç°æœ‰ç³»ç»Ÿé›†æˆç‚¹

| é›†æˆç‚¹ | è¯´æ˜ |
|--------|------|
| **Tool SPI** | `PythonExecutorTool` ç»§æ‰¿ `BaseTool`ï¼Œè‡ªåŠ¨è¢«å‘ç°æ³¨å†Œ |
| **ToolExecutor** | é€šè¿‡æ ‡å‡† `execute()` è°ƒç”¨é“¾æ‰§è¡Œï¼Œäº«å—å¹¶è¡Œæ‰§è¡Œ / è¶…æ—¶ / é”™è¯¯æ¢å¤ |
| **Config** | `SandboxConfig` æŒ‚è½½åˆ° `Settings.sandbox`ï¼Œæ”¯æŒç¯å¢ƒå˜é‡è¦†ç›– |
| **System Prompt** | å¯åœ¨ system prompt ä¸­å‘ŠçŸ¥ LLM æ‹¥æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ› |
| **SSE æµå¼** | å·¥å…·æ‰§è¡Œç»“æœä½œä¸º `tool` æ¶ˆæ¯å›ä¼ ï¼ŒLLM åŸºäºç»“æœç»§ç»­ç”Ÿæˆ |

#### è¿è¡Œå‰ç½®æ¡ä»¶

```bash
# 1. ç¡®ä¿ Docker å·²å®‰è£…å¹¶è¿è¡Œ
docker --version
docker info

# 2. é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ„å»ºæ²™ç®±é•œåƒï¼ˆçº¦ 1-2 åˆ†é’Ÿï¼‰
#    æˆ–æ‰‹åŠ¨æ„å»ºï¼š
docker build -t agent-sandbox:latest ./sandbox/

# 3. å®‰è£… Python Docker SDK
pip install docker>=7.0.0
```

> å¦‚æœå®¿ä¸»æœºæ²¡æœ‰å®‰è£… Dockerï¼Œ`CodeExecutor.initialize()` ä¼šæŠ›å‡ºæ˜ç¡®é”™è¯¯å¹¶è®°å½•æ—¥å¿—ï¼Œå…¶ä»–å·¥å…·ä¸å—å½±å“ã€‚

### 6) Todo ä»»åŠ¡è¿›åº¦è¿½è¸ªï¼ˆæ ¸å¿ƒå®ç°ï¼‰

Todo åŠŸèƒ½å…è®¸ LLM åœ¨å¤„ç†å¤šæ­¥éª¤ä»»åŠ¡æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºå¹¶ç»´æŠ¤ä¸€ä»½å¯è§†åŒ–çš„ä»»åŠ¡æ¸…å•ï¼Œå‰ç«¯å¯å®æ—¶å±•ç¤ºæ­¥éª¤è¿›åº¦ã€‚

#### Todo å¦‚ä½•è¢«å¼€å¯

Todo åŠŸèƒ½**ä¸æ˜¯**ç”±ç”¨æˆ·æ‰‹åŠ¨å¼€å…³ï¼Œè€Œæ˜¯ç”± LLM è‡ªä¸»åˆ¤æ–­æ˜¯å¦éœ€è¦ï¼š

1. **System Prompt æ³¨å…¥**ï¼š`ChatAgent` åœ¨æ¯æ¬¡å¯¹è¯æ—¶ï¼Œå°† `TODO_SYSTEM_PROMPT` è¿½åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯ä¸­ï¼Œå‘ŠçŸ¥ LLM æ‹¥æœ‰ `manage_todo_list` å·¥å…·ã€‚
2. **LLM è‡ªä¸»è°ƒç”¨**ï¼šå½“ LLM åˆ¤æ–­å½“å‰ä»»åŠ¡éœ€è¦å¤šæ­¥éª¤å®Œæˆï¼ˆå¦‚å¤šé˜¶æ®µåˆ†æã€æ‰¹é‡æ“ä½œç­‰ï¼‰ï¼Œå®ƒä¼šè‡ªè¡Œå‘èµ· `manage_todo_list` å·¥å…·è°ƒç”¨ã€‚
3. **å·¥å…·æ‹¦æˆª**ï¼š`ChatAgent` åœ¨å¤„ç†å·¥å…·è°ƒç”¨æ—¶ï¼Œå°† `manage_todo_list` ä»æ™®é€šå·¥å…·ä¸­åˆ†ç¦»ï¼Œå•ç‹¬è·¯ç”±åˆ° `TodoService`ï¼Œä¸ç»è¿‡ `ToolExecutor`ã€‚

```python
# core.py ä¸­çš„ system prompt ç‰‡æ®µ
TODO_SYSTEM_PROMPT = """ä½ æ‹¥æœ‰ä¸€ä¸ªåä¸º manage_todo_list çš„å·¥å…·ã€‚
å½“ç”¨æˆ·çš„è¯·æ±‚éœ€è¦å¤šæ­¥éª¤æ‰èƒ½å®Œæˆæ—¶ï¼ˆä¾‹å¦‚ï¼šå¤šé˜¶æ®µåˆ†æã€å¤šæ–‡ä»¶æ“ä½œã€å¤æ‚è®¡åˆ’æ‰§è¡Œç­‰ï¼‰ï¼Œ
ä½ **å¿…é¡»**åœ¨å¼€å§‹å·¥ä½œå‰å…ˆè°ƒç”¨ manage_todo_list æ¥åˆ›å»ºä»»åŠ¡æ¸…å•ã€‚

ä½¿ç”¨è§„åˆ™ï¼š
1. åœ¨å¼€å§‹å¤šæ­¥éª¤ä»»åŠ¡å‰ï¼Œè°ƒç”¨ manage_todo_list åˆ›å»ºå®Œæ•´çš„æ­¥éª¤æ¸…å•ï¼ˆæ‰€æœ‰æ­¥éª¤ pendingï¼Œç¬¬ä¸€æ­¥è®¾ä¸º runningï¼‰ã€‚
2. æ¯å®Œæˆä¸€ä¸ªæ­¥éª¤åï¼Œå†æ¬¡è°ƒç”¨ manage_todo_listï¼Œå°†å·²å®Œæˆçš„æ­¥éª¤æ ‡è®°ä¸º completedï¼Œä¸‹ä¸€æ­¥æ ‡è®°ä¸º runningã€‚
3. æ¯æ¬¡è°ƒç”¨éƒ½å¿…é¡»å‘é€**å®Œæ•´åˆ—è¡¨**ï¼ˆä¸æ˜¯å¢é‡æ›´æ–°ï¼‰ã€‚
4. åŒä¸€æ—¶é—´æœ€å¤šåªæœ‰ä¸€ä¸ªæ­¥éª¤å¤„äº running çŠ¶æ€ã€‚
5. å¯¹äºç®€å•çš„å•æ­¥ä»»åŠ¡ï¼ˆå¦‚ç®€å•é—®ç­”ã€ç¿»è¯‘ç­‰ï¼‰ï¼Œ**ä¸è¦**è°ƒç”¨æ­¤å·¥å…·ã€‚
"""
```

è§¦å‘æ—¶æœºç¤ºæ„å›¾ï¼š

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â”‚
  â–¼
ChatAgent.chat_stream()
  â”‚
  â”œâ”€ æ³¨å…¥ TODO_SYSTEM_PROMPT åˆ° system æ¶ˆæ¯
  â”œâ”€ æ³¨å†Œ manage_todo_list åˆ°å·¥å…·åˆ—è¡¨
  â”‚
  â–¼
LLM è¿”å›å“åº”
  â”‚
  â”œâ”€ è‹¥åŒ…å« manage_todo_list è°ƒç”¨ â”€â”€â†’ æ‹¦æˆªï¼Œè·¯ç”±åˆ° TodoService
  â”‚                                      â”‚
  â”‚                                      â”œâ”€ å†™å…¥ / æ›´æ–°æ•°æ®åº“
  â”‚                                      â”œâ”€ SSE æ¨é€ todo å¿«ç…§
  â”‚                                      â””â”€ è¿”å›ç¡®è®¤ç»™ LLM
  â”‚
  â””â”€ å…¶ä»–å·¥å…·è°ƒç”¨ â”€â”€â†’ æ­£å¸¸èµ° ToolExecutor
```

#### æœ‰ Todos å’Œæ²¡æœ‰ Todos çš„ä¼šè¯åŒºåˆ«

| ç»´åº¦ | æ™®é€šä¼šè¯ | å« Todos çš„ä¼šè¯ |
|------|---------|----------------|
| **æ•°æ®åº“** | ä»… `sessions` + `messages` è¡¨ | é¢å¤–å…³è” `session_todo_lists` + `session_todo_items` è¡¨ |
| **SSE äº‹ä»¶** | `session` / `thinking` / `content` / `done` | é¢å¤–æ¨é€ `todo_list` ç±»å‹äº‹ä»¶ |
| **å·¥å…·è°ƒç”¨** | æ‰€æœ‰å·¥å…·èµ° `ToolExecutor` | `manage_todo_list` è¢«æ‹¦æˆªèµ° `TodoService`ï¼Œå…¶ä½™ä¸å˜ |
| **System Prompt** | åŸæœ‰ system æ¶ˆæ¯ | é¢å¤–è¿½åŠ  `TODO_SYSTEM_PROMPT` æ®µè½ |
| **REST ç«¯ç‚¹** | æ—  todo ç›¸å…³ | `GET /sessions/{id}/todo-list` è¿”å›å¿«ç…§ |
| **SessionModel å…³ç³»** | `todo_list` ä¸º `None` | `todo_list` æŒ‡å‘ `TodoListModel` å®ä¾‹ |

å¯¹äºå‰ç«¯ï¼š
- æ™®é€šä¼šè¯ï¼š`StreamChunk` ä¸­ `todo_list` å­—æ®µå§‹ç»ˆä¸º `null`ï¼Œå‰ç«¯ä¸æ˜¾ç¤º todo é¢æ¿
- å« Todos ä¼šè¯ï¼šæ”¶åˆ° `type="todo_list"` äº‹ä»¶æ—¶æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ï¼›é¡µé¢åˆ·æ–°åé€šè¿‡ REST æ¢å¤

#### æŒä¹…åŒ–è®¾è®¡

Todo æ•°æ®å­˜å‚¨åœ¨ä¸¤å¼  PostgreSQL è¡¨ä¸­ï¼Œä¸ `sessions` è¡¨é€šè¿‡å¤–é”®å…³è”ï¼š

```
sessions (1) â”€â”€â”€â”€ (0..1) session_todo_lists (1) â”€â”€â”€â”€ (N) session_todo_items
```

**session_todo_lists è¡¨ï¼š**

| åˆ— | ç±»å‹ | è¯´æ˜ |
|----|------|------|
| `id` | UUID PK | ä¸»é”® |
| `session_id` | UUID FK UNIQUE | å…³è” sessionsï¼Œä¸€å¯¹ä¸€ |
| `title` | VARCHAR(255) | ä»»åŠ¡æ¸…å•æ ‡é¢˜ |
| `revision` | INTEGER | ä¹è§‚é”ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å†™æ“ä½œ +1 |
| `status` | VARCHAR(50) | `active` / `completed` / `archived` |
| `created_at` / `updated_at` | TIMESTAMPTZ | æ—¶é—´æˆ³ |

**session_todo_items è¡¨ï¼š**

| åˆ— | ç±»å‹ | è¯´æ˜ |
|----|------|------|
| `id` | UUID PK | ä¸»é”® |
| `todo_list_id` | UUID FK | å…³è” session_todo_lists |
| `label` | VARCHAR(500) | æ­¥éª¤æè¿° |
| `status` | VARCHAR(50) | `pending` / `running` / `completed` |
| `order_index` | INTEGER | æ’åºåºå· |
| `created_at` / `updated_at` | TIMESTAMPTZ | æ—¶é—´æˆ³ |

å…³é”®çº¦æŸï¼š
- `session_id` ä¸Šå»ºç«‹ UNIQUE ç´¢å¼•ï¼Œä¿è¯æ¯ä¸ªä¼šè¯æœ€å¤šä¸€ä¸ª todo-list
- å¤–é”®ä½¿ç”¨ `ON DELETE CASCADE`ï¼Œåˆ é™¤ä¼šè¯æ—¶è‡ªåŠ¨çº§è”æ¸…é™¤ todo æ•°æ®
- `revision` ç”¨äºå¹¶å‘æ§åˆ¶ï¼šå‰ç«¯å¯ç”¨æ­¤å­—æ®µåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°æ¸²æŸ“

#### SSE æ¨é€åè®®

æ¯æ¬¡ todo å˜æ›´ï¼Œåç«¯é€šè¿‡ SSE æ¨é€å®Œæ•´ todo å¿«ç…§ï¼ˆéå¢é‡ï¼‰ï¼š

```json
data: {
  "session_id": "550e8400-...",
  "type": "todo_list",
  "delta": "",
  "todo_list": {
    "id": "a1b2c3d4-...",
    "title": "æ•°æ®åˆ†ææµç¨‹",
    "items": [
      {"id": "...", "label": "æ”¶é›†æ•°æ®æº", "status": "completed", "order_index": 1},
      {"id": "...", "label": "æ•°æ®æ¸…æ´—",   "status": "running",   "order_index": 2},
      {"id": "...", "label": "å»ºæ¨¡è¯„ä¼°",   "status": "pending",   "order_index": 3}
    ],
    "revision": 3,
    "updated_at": "2026-02-12T10:30:00Z"
  }
}
```

#### æœåŠ¡å±‚æ¶æ„

```
ChatAgent (core.py)
  â”‚  æ‹¦æˆª manage_todo_list å·¥å…·è°ƒç”¨
  â–¼
TodoService (services/todo_service.py)
  â”‚  ä¸šåŠ¡é€»è¾‘ + SSE å¹¿æ’­
  â–¼
TodoRepository (database/todo_repository.py)
  â”‚  CRUD + revision ç®¡ç†
  â–¼
PostgreSQL (session_todo_lists + session_todo_items)
```

`TodoService` å…³é”®æ–¹æ³•ï¼š

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `create_todo_list(session_id, title, labels)` | åˆ›å»ºæ¸…å•ï¼Œé¦–é¡¹è‡ªåŠ¨ running |
| `create_or_replace_with_items(session_id, title, items)` | ç”¨ LLM ç»™å‡ºçš„ç²¾ç¡®çŠ¶æ€åˆ›å»º/æ›¿æ¢æ¸…å• |
| `advance_step(session_id)` | runningâ†’completedï¼Œä¸‹ä¸€ä¸ª pendingâ†’running |
| `set_item_status(session_id, item_id, status)` | è®¾ç½®æŒ‡å®šé¡¹çŠ¶æ€ |
| `complete_all(session_id)` | æ ‡è®°æ‰€æœ‰é¡¹ä¸º completed |
| `clear(session_id)` | åˆ é™¤æ•´ä¸ª todo-list |
| `get_todo_list(session_id)` | åªè¯»æŸ¥è¯¢ï¼ˆæ— å¹¿æ’­ï¼‰ |

---

## 6 APIs

### èŠå¤©æ¥å£

#### å‘é€æ¶ˆæ¯ (éæµå¼)

```http
POST /api/v1/chat/
Content-Type: application/json

{
  "message": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±",
  "session_id": "uuid-or-null-for-new-session"
}
```

**å“åº”:**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "message": {
    "id": "...",
    "role": "assistant",
    "content": "ä½ å¥½ï¼æˆ‘æ˜¯Chat Agent...",
    "created_at": "2024-01-01T00:00:00Z"
  },
  "status": "completed",
  "usage": {
    "prompt_tokens": 20,
    "completion_tokens": 100,
    "total_tokens": 120
  }
}
```

#### å‘é€æ¶ˆæ¯ (æµå¼)

```http
POST /api/v1/chat/stream
Content-Type: application/json

{
  "message": "å†™ä¸€ä¸ªPythonå‡½æ•°",
  "session_id": "uuid-or-null"
}
```

**SSE å“åº”æ ¼å¼:**
```
data: {"session_id":"...","type":"session","delta":"uuid"}

data: {"session_id":"...","type":"thinking","thinking":"è®©æˆ‘æ€è€ƒä¸€ä¸‹..."}

data: {"session_id":"...","type":"content","delta":"å¥½çš„"}

data: {"session_id":"...","type":"content","delta":"ï¼Œæˆ‘æ¥"}

data: {"session_id":"...","type":"done","is_thinking_complete":true}
```

#### ç”Ÿæˆå¯¹è¯æ ‡é¢˜

```http
POST /api/v1/chat/title
Content-Type: application/json

{
  "session_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**å“åº”:**
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "title": "Pythonå‡½æ•°ç¼–å†™è®¨è®º"
}
```

### ä¼šè¯ç®¡ç†

#### è·å–ä¼šè¯åˆ—è¡¨

```http
GET /api/v1/sessions/?page=1&page_size=20
```

#### è·å–ä¼šè¯è¯¦æƒ…

```http
GET /api/v1/sessions/{session_id}
```

#### åˆ é™¤ä¼šè¯

```http
DELETE /api/v1/sessions/{session_id}
```

### Todo æ¥å£

#### è·å–ä¼šè¯ Todo åˆ—è¡¨

```http
GET /api/v1/sessions/{session_id}/todo-list
```

**å“åº” (200):**
```json
{
  "id": "a1b2c3d4-...",
  "title": "æ•°æ®åˆ†ææµç¨‹",
  "items": [
    {"id": "...", "label": "æ”¶é›†æ•°æ®æº", "status": "completed", "order_index": 1},
    {"id": "...", "label": "æ•°æ®æ¸…æ´—",   "status": "running",   "order_index": 2},
    {"id": "...", "label": "å»ºæ¨¡è¯„ä¼°",   "status": "pending",   "order_index": 3}
  ],
  "revision": 3,
  "updated_at": "2026-02-12T10:30:00Z"
}
```

**å…¶ä»–å“åº”ç :**
- `204 No Content` â€” è¯¥ä¼šè¯æ²¡æœ‰ todo-list
- `404 Not Found` â€” session_id ä¸å­˜åœ¨

> æ­¤ç«¯ç‚¹ç”¨äºå‰ç«¯é¡µé¢åˆ·æ–°æˆ–åˆ‡æ¢ä¼šè¯æ—¶æ¢å¤ todo çŠ¶æ€ã€‚å®æ—¶æ›´æ–°é€šè¿‡ `/chat/stream` SSE çš„ `todo_list` äº‹ä»¶è·å–ã€‚

---

## 7 é…ç½®è¯´æ˜

### åç«¯é…ç½® (.env)

```env
# ============ OpenAI é…ç½® ============
OPENAI_API_KEY=your-api-key-here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o-mini
OPENAI_MAX_TOKENS=4096
OPENAI_TEMPERATURE=0.7
OPENAI_TIMEOUT=60.0
OPENAI_MAX_RETRIES=3

# ============ å†…å­˜é…ç½® ============
MEMORY_MAX_CONTEXT_TOKENS=128000
MEMORY_COMPRESSION_THRESHOLD=0.92
MEMORY_TARGET_COMPRESSION_RATIO=0.3
MEMORY_MAX_MESSAGES_IN_MEMORY=100
MEMORY_SUMMARY_MAX_TOKENS=500
MEMORY_IMPORTANCE_DECAY_FACTOR=0.95

# ============ Agent é…ç½® ============
AGENT_MAX_ITERATIONS=10
AGENT_ITERATION_TIMEOUT=300
AGENT_ENABLE_PARALLEL_TOOLS=true
AGENT_MAX_PARALLEL_TOOLS=5
AGENT_ENABLE_INTERRUPTION=true

# ============ æ¶ˆæ¯é˜Ÿåˆ—é…ç½® ============
QUEUE_BACKEND=memory
# Redis é…ç½® (å¦‚æœä½¿ç”¨ Redis)
QUEUE_REDIS_URL=redis://localhost:6379/0
# Kafka é…ç½® (å¦‚æœä½¿ç”¨ Kafka)
QUEUE_KAFKA_BOOTSTRAP_SERVERS=localhost:9092
QUEUE_KAFKA_TOPIC_PREFIX=agent
# æ¶ˆæ¯ TTLï¼ˆå½“å‰åç«¯æ¶ˆè´¹é“¾è·¯æœªå¯ç”¨ï¼‰
QUEUE_MESSAGE_TTL=3600  # `ã€æœªå®ç°ã€‘`

# ============ ä»£ç æ²™ç®±é…ç½® ============
SANDBOX_ENABLED=true                       # å¯ç”¨ä»£ç æ‰§è¡Œæ²™ç®±
SANDBOX_IMAGE_NAME=agent-sandbox:latest    # Docker é•œåƒå
SANDBOX_AUTO_BUILD_IMAGE=true              # é•œåƒä¸å­˜åœ¨æ—¶è‡ªåŠ¨æ„å»º
SANDBOX_EXECUTION_TIMEOUT=30               # é»˜è®¤æ‰§è¡Œè¶…æ—¶(ç§’)
SANDBOX_MAX_EXECUTION_TIMEOUT=120          # æœ€å¤§å…è®¸è¶…æ—¶(ç§’)
SANDBOX_MAX_OUTPUT_SIZE=65536              # æœ€å¤§è¾“å‡ºå­—èŠ‚æ•° (64KB)
SANDBOX_MEMORY_LIMIT=256m                  # å®¹å™¨å†…å­˜é™åˆ¶
SANDBOX_CPU_PERIOD=100000                  # CPU CFS å‘¨æœŸ(å¾®ç§’)
SANDBOX_CPU_QUOTA=50000                    # CPU CFS é…é¢(50%å•æ ¸)
SANDBOX_PIDS_LIMIT=64                      # å®¹å™¨æœ€å¤§è¿›ç¨‹æ•°
SANDBOX_NETWORK_ENABLED=false              # é»˜è®¤ç¦ç”¨ç½‘ç»œ
SANDBOX_CONTAINER_WORKDIR=/workspace       # å®¹å™¨å·¥ä½œç›®å½•

# ============ æ•°æ®åº“é…ç½® ============
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/agent_db

# ============ æœåŠ¡å™¨é…ç½® ============
SERVER_HOST=0.0.0.0
SERVER_PORT=8000
SERVER_DEBUG=true
SERVER_CORS_ORIGINS=["http://localhost:5173","http://localhost:3000"]

# ============ åº”ç”¨é…ç½® ============
ENVIRONMENT=development
```

### å‰ç«¯é…ç½®

åˆ›å»º `.env.local`:

```env
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

---

## 8 æ‰©å±•å¼€å‘

### æ·»åŠ è‡ªå®šä¹‰å·¥å…·

```python
from app.agent.executor import BaseTool

class WeatherTool(BaseTool):
    """å¤©æ°”æŸ¥è¯¢å·¥å…·"""
    
    @property
    def name(self) -> str:
        return "get_weather"
    
    @property
    def description(self) -> str:
        return "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯"
    
    @property
    def parameters(self) -> dict:
        return {
            "type": "object",
            "properties": {
                "city": {
                    "type": "string",
                    "description": "åŸå¸‚åç§°"
                },
                "unit": {
                    "type": "string",
                    "enum": ["celsius", "fahrenheit"],
                    "description": "æ¸©åº¦å•ä½"
                }
            },
            "required": ["city"]
        }
    
    async def execute(self, city: str, unit: str = "celsius") -> str:
        # å®ç°å¤©æ°”æŸ¥è¯¢é€»è¾‘
        weather_data = await fetch_weather(city)
        return f"{city}å½“å‰æ¸©åº¦: {weather_data['temp']}Â°"

# æ³¨å†Œå·¥å…·
from app.agent.core import ChatAgent

agent = ChatAgent()
agent.register_tool(WeatherTool())
```

### SPI æœåŠ¡å‘ç°ï¼ˆæ¨èï¼‰

æ¡†æ¶é‡‡ç”¨â€œæœåŠ¡å‘ç°â€æ–¹å¼åŠ è½½å·¥å…·ï¼Œå®Œæ•´å®ç°ç»†èŠ‚å·²æ”¶æ•›åˆ° **5 æ ¸å¿ƒæ¨¡å—è¯¦è§£ â†’ 4) Tool SPI æ³¨å†Œä¸å‘ç°ï¼ˆæ ¸å¿ƒå®ç°ï¼‰**ï¼Œæœ¬èŠ‚ä»…ä¿ç•™æ¥å…¥ç¤ºä¾‹ã€‚

#### ç¬¬ä¸‰æ–¹åŒ…æ¥å…¥ç¤ºä¾‹ï¼ˆ`pyproject.toml`ï¼‰

```toml
[project.entry-points."chat_agent_framework.tools"]
weather = "my_plugin.weather:WeatherTool"
batch_tools = "my_plugin.bundle:provide_tools"
```

å…¶ä¸­ `provide_tools` å¯ä»¥è¿”å›ï¼š

- å•ä¸ª `BaseTool` å­ç±»/å®ä¾‹
- æˆ–å·¥å…·åˆ—è¡¨ï¼ˆå¯æ··åˆç±»ä¸å®ä¾‹ï¼‰

### æ·»åŠ è‡ªå®šä¹‰ä¸­é—´ä»¶

```python
from app.messaging.pipeline import PipelineMiddleware, PipelineContext
from typing import Callable, Awaitable

class AuthMiddleware(PipelineMiddleware):
    """è®¤è¯ä¸­é—´ä»¶"""
    
    @property
    def name(self) -> str:
        return "auth"
    
    async def process(
        self,
        context: PipelineContext,
        next_handler: Callable[[PipelineContext], Awaitable]
    ):
        # éªŒè¯ token
        token = context.metadata.get("token")
        if not self._validate_token(token):
            raise UnauthorizedError("Invalid token")
        
        # ç»§ç»­å¤„ç†
        return await next_handler(context)
    
    def _validate_token(self, token: str) -> bool:
        # å®ç°éªŒè¯é€»è¾‘
        return True

# ä½¿ç”¨ä¸­é—´ä»¶
pipeline.use(AuthMiddleware())
```

### è‡ªå®šä¹‰å‹ç¼©ç­–ç•¥

```python
from app.memory.compressor import CompressionStrategy

class CustomCompressor(CompressionStrategy):
    """è‡ªå®šä¹‰å‹ç¼©ç­–ç•¥"""
    
    async def compress(
        self,
        messages: list[Message],
        target_ratio: float
    ) -> tuple[list[Message], str | None]:
        # å®ç°è‡ªå®šä¹‰å‹ç¼©é€»è¾‘
        retained = []
        summary = None
        
        for msg in messages:
            if self._should_keep(msg):
                retained.append(msg)
            else:
                summary = await self._summarize(msg)
        
        return retained, summary
```

---

## 9 æŠ€æœ¯æ ˆ

### åç«¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Python | 3.12+ | è¿è¡Œæ—¶ |
| FastAPI | 0.115+ | Webæ¡†æ¶ |
| Pydantic | 2.10+ | æ•°æ®éªŒè¯ |
| OpenAI SDK | 1.55+ | LLMè°ƒç”¨ |
| Tiktoken | 0.8+ | Tokenè®¡æ•° |
| Structlog | 24.4+ | æ—¥å¿—ç³»ç»Ÿ |
| Redis | 5.2+ | æ¶ˆæ¯é˜Ÿåˆ—(å¯é€‰) |
| Aiokafka | 0.12+ | Kafkaæ”¯æŒ(å¯é€‰) |
| Docker SDK | 7.0+ | ä»£ç æ²™ç®±å®¹å™¨ç®¡ç† |

### å‰ç«¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Vue | 3.5+ | UIæ¡†æ¶ |
| TypeScript | 5.6+ | ç±»å‹ç³»ç»Ÿ |
| Pinia | 2.2+ | çŠ¶æ€ç®¡ç† |
| Vite | 5.4+ | æ„å»ºå·¥å…· |
| Tailwind CSS | 3.4+ | æ ·å¼æ¡†æ¶ |
| Marked | 14.0+ | Markdownè§£æ |
| Axios | 1.7+ | HTTPå®¢æˆ·ç«¯ |

---

## 10 License

MIT License

---

<div align="center">

**Made with â¤ï¸ by Chat Agent Framework Team**

</div>
